
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>defdap.fepx &#8212; DefDAP 0.1 documentation</title>
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">DefDAP 0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for defdap.fepx</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">fnmatch</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.mlab</span> <span class="k">import</span> <span class="n">griddata</span>
<span class="kn">from</span> <span class="nn">matplotlib.collections</span> <span class="k">import</span> <span class="n">LineCollection</span><span class="p">,</span> <span class="n">PolyCollection</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">animation</span>

<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="k">import</span> <span class="n">clear_output</span>

<span class="kn">import</span> <span class="nn">pyevtk.vtk</span>

<span class="kn">import</span> <span class="nn">vtk</span>
<span class="kn">from</span> <span class="nn">vtk.util</span> <span class="k">import</span> <span class="n">numpy_support</span> <span class="k">as</span> <span class="n">vnp</span>

<span class="kn">from</span> <span class="nn">defdap.quat</span> <span class="k">import</span> <span class="n">Quat</span>


<div class="viewcode-block" id="Mesh"><a class="viewcode-back" href="../../defdap.html#defdap.fepx.Mesh">[docs]</a><span class="k">class</span> <span class="nc">Mesh</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1">### object variables ###</span>
    <span class="c1"># meshDir</span>
    <span class="c1"># dataDir</span>

    <span class="c1">### MESH DATA ###</span>
    <span class="c1"># numElmts(int)</span>
    <span class="c1"># numNodes(int)</span>
    <span class="c1"># elType(int)</span>
    <span class="c1"># elmtCon[numElmnts, 10](int) - Nodes for each element - node numbers are 0 based. row-major</span>
    <span class="c1"># nodePos[numNodes, 3](float) - Initial position of each node. col-major</span>
    <span class="c1"># numGrains(int) - number of grains in mesh</span>
    <span class="c1"># elmtGrain[numElmts](int) - Grain ID of each element - grain ID is 1 based</span>
    <span class="c1"># elmtPhase[numElmts](int) - Phase ID of each element - phase ID is 1 based</span>
    <span class="c1"># grainOris[numGrains, 3](float) - Initial Euler angles of each grain (Bunge, radians). col-major</span>

    <span class="c1">### SIMULATION DATA ###</span>
    <span class="c1"># numFrames(int) - Number of load steps output</span>
    <span class="c1"># numProcs(int) - Number of cores the simulation was run on</span>
    <span class="c1"># numSlipSys(int) - Number of slip systems</span>

    <span class="c1"># simData - Dictionary of arrays storing loaded simulation data. Arrays stored in column major order.</span>
    <span class="c1"># simData[&#39;nodePos&#39;][numElmts, 3, numFrames+1](float) - Node positions</span>
    <span class="c1"># simData[&#39;angle&#39;][numElmts, 3, numFrames+1](float) - Euler angles of each element (Bunge, radians)</span>
    <span class="c1"># simData[&#39;ori&#39;][numElmts, numFrames+1](Quat) - Quat of orientation of each element</span>

    <span class="c1"># misOri</span>

    <span class="c1"># Key values for simulation data. Loaded are loaded from file while created are calclated here.</span>
    <span class="n">simDataKeysStatic</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;nodePos&quot;</span><span class="p">,</span>
        <span class="s2">&quot;nodeVel&quot;</span><span class="p">,</span>
        <span class="s2">&quot;angle&quot;</span><span class="p">,</span>
        <span class="s2">&quot;hardness&quot;</span><span class="p">,</span>
        <span class="s2">&quot;strain&quot;</span><span class="p">,</span>
        <span class="s2">&quot;stress&quot;</span><span class="p">,</span>
        <span class="s2">&quot;shearRate&quot;</span><span class="p">,</span>
        <span class="s2">&quot;effDefRate&quot;</span><span class="p">,</span>
        <span class="s2">&quot;effPlasticDefRate&quot;</span><span class="p">,</span>
        <span class="s2">&quot;eqvStrain&quot;</span><span class="p">,</span>
        <span class="s2">&quot;eqvPlasticStrain&quot;</span><span class="p">,</span>
        <span class="s2">&quot;backstress&quot;</span>
    <span class="p">)</span>
    <span class="c1"># Any sim data with 3 components is assumed to be a vector unless added to this list</span>
    <span class="n">simDataKeysNotVectorStatic</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;angle&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">meshDir</span><span class="o">=</span><span class="s2">&quot;./&quot;</span><span class="p">,</span> <span class="n">dataDir</span><span class="o">=</span><span class="s2">&quot;./&quot;</span><span class="p">,</span> <span class="n">grainFilename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">MESH_FILE_EX</span> <span class="o">=</span> <span class="s2">&quot;mesh&quot;</span>
        <span class="n">GRAIN_FILE_EX</span> <span class="o">=</span> <span class="s2">&quot;grain&quot;</span>
        <span class="n">ORI_FILE_EX</span> <span class="o">=</span> <span class="s2">&quot;ori&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">meshName</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meshDir</span> <span class="o">=</span> <span class="n">meshDir</span> <span class="k">if</span> <span class="n">meshDir</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;/&quot;</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="si">{:s}{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">meshDir</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataDir</span> <span class="o">=</span> <span class="n">dataDir</span> <span class="k">if</span> <span class="n">dataDir</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;/&quot;</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="si">{:s}{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataDir</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">grainFilename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">grainFilename</span> <span class="o">=</span> <span class="n">name</span>

        <span class="c1"># open mesh file</span>
        <span class="n">fileName</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}{:s}</span><span class="s2">.</span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meshDir</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">MESH_FILE_EX</span><span class="p">)</span>
        <span class="n">meshFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>

        <span class="c1"># read header</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">meshFile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">numElmts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numNodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elType</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">header</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>

        <span class="c1"># read element connectivity data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elmtCon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">meshFile</span><span class="p">,</span>
                                     <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                                     <span class="n">max_rows</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">numElmts</span><span class="p">,</span>
                                     <span class="n">usecols</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">)))</span>

        <span class="c1"># read node positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodePos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asfortranarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">meshFile</span><span class="p">,</span>
                                                       <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                                                       <span class="n">max_rows</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">numNodes</span><span class="p">,</span>
                                                       <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]))</span>

        <span class="c1"># read number of surfaces</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numSurfaces</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">meshFile</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surfaces</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numSurfaces</span><span class="p">):</span>
            <span class="n">numElmts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">meshFile</span><span class="p">))</span>
            <span class="n">elmtCon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">meshFile</span><span class="p">,</span>
                                    <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                                    <span class="n">max_rows</span><span class="o">=</span><span class="n">numElmts</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">surfaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Surface</span><span class="p">(</span><span class="n">i</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="p">,</span>
                                         <span class="n">numElmts</span><span class="p">,</span>
                                         <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">elmtCon</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]),</span>
                                         <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">elmtCon</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:])))</span>

        <span class="c1"># close mesh file</span>
        <span class="n">meshFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># open grain file</span>
        <span class="n">fileName</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}{:s}</span><span class="s2">.</span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meshDir</span><span class="p">,</span> <span class="n">grainFilename</span><span class="p">,</span> <span class="n">GRAIN_FILE_EX</span><span class="p">)</span>
        <span class="n">grainFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>

        <span class="c1"># read header</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">grainFile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numGrains</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">header</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>

        <span class="c1"># read grain and phase info for each element</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elmtGrain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elmtPhase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">grainFile</span><span class="p">,</span>
                                                                            <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                                                                            <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                                            <span class="n">max_rows</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">numElmts</span><span class="p">))</span>

        <span class="c1"># close grain file</span>
        <span class="n">grainFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># open ori file and read orientation of each grain (Kocks Euler angles in degrees)</span>
        <span class="n">fileName</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}{:s}</span><span class="s2">.</span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meshDir</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ORI_FILE_EX</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grainOris</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asfortranarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span>
                                                         <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                                                         <span class="n">skip_header</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                                         <span class="n">max_rows</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">numGrains</span><span class="p">,</span>
                                                         <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]))</span>

        <span class="c1"># convert to Bunge Euler angles in radians</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grainOris</span> <span class="o">*=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grainOris</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grainOris</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grainOris</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="c1"># create empty dictionary for storing simulaton data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simData</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># set to none so we tell if element stats have been loaded</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elStats</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">simDataKeysDyn</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simDataKeysNotVectorDyn</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">simDataKeys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Mesh</span><span class="o">.</span><span class="n">simDataKeysStatic</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simDataKeysDyn</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">simDataKeysNotVector</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Mesh</span><span class="o">.</span><span class="n">simDataKeysNotVectorStatic</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simDataKeysNotVectorDyn</span><span class="p">)</span>

<div class="viewcode-block" id="Mesh.simMetaData"><a class="viewcode-back" href="../../defdap.html#defdap.fepx.Mesh.simMetaData">[docs]</a>    <span class="k">def</span> <span class="nf">simMetaData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataKey</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Produces a dictionary of metadata for the given datakey. Meta data consists of:</span>
<span class="sd">            - dataKey (string)</span>
<span class="sd">            - includesInitial (bool)</span>
<span class="sd">            - numComponents (int)</span>
<span class="sd">            - numFrames (int)</span>
<span class="sd">            - nodeData (bool): True if node data</span>
<span class="sd">            - elmtData (bool): True if element data</span>
<span class="sd">            - grainData (bool): True if grain data</span>
<span class="sd">            - shape (tuple): shape of data array</span>
<span class="sd">            - notVector (bool): True if the data components do not represent a vector</span>

<span class="sd">        Args:</span>
<span class="sd">            dataKey (string): Sim datakey</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Metadata</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">includesInitial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="n">dataKey</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">numFrames</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">numComponents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="n">dataKey</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="n">dataKey</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="n">nodeData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="n">dataKey</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">numNodes</span>
        <span class="n">elmtData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="n">dataKey</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">numElmts</span>
        <span class="n">grainData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="n">dataKey</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">numGrains</span>
        <span class="n">notVector</span> <span class="o">=</span> <span class="n">dataKey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">simDataKeysNotVector</span>

        <span class="n">metaData</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;dataKey&quot;</span><span class="p">:</span> <span class="n">dataKey</span><span class="p">,</span>
            <span class="s2">&quot;includesInitial&quot;</span><span class="p">:</span> <span class="n">includesInitial</span><span class="p">,</span>
            <span class="s2">&quot;numComponents&quot;</span><span class="p">:</span> <span class="n">numComponents</span><span class="p">,</span>
            <span class="s2">&quot;numFrames&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="n">dataKey</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;nodeData&quot;</span><span class="p">:</span> <span class="n">nodeData</span><span class="p">,</span>
            <span class="s2">&quot;elmtData&quot;</span><span class="p">:</span> <span class="n">elmtData</span><span class="p">,</span>
            <span class="s2">&quot;grainData&quot;</span><span class="p">:</span> <span class="n">grainData</span><span class="p">,</span>
            <span class="s2">&quot;shape&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="n">dataKey</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
            <span class="s2">&quot;notVector&quot;</span><span class="p">:</span> <span class="n">notVector</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">metaData</span></div>

<div class="viewcode-block" id="Mesh.simDataInfo"><a class="viewcode-back" href="../../defdap.html#defdap.fepx.Mesh.simDataInfo">[docs]</a>    <span class="k">def</span> <span class="nf">simDataInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span></div>

<div class="viewcode-block" id="Mesh.setSimParams"><a class="viewcode-back" href="../../defdap.html#defdap.fepx.Mesh.setSimParams">[docs]</a>    <span class="k">def</span> <span class="nf">setSimParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">numProcs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numFrames</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numSlipSys</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">numProcs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">numProcs</span> <span class="o">=</span> <span class="n">numProcs</span>
        <span class="k">if</span> <span class="n">numFrames</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">numFrames</span> <span class="o">=</span> <span class="n">numFrames</span>
        <span class="k">if</span> <span class="n">numSlipSys</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">numSlipSys</span> <span class="o">=</span> <span class="n">numSlipSys</span></div>

    <span class="k">def</span> <span class="nf">_validateSimDataKey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataKey</span><span class="p">,</span> <span class="n">fieldType</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dataKey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fieldType</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">fieldType</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                    <span class="n">fieldType</span> <span class="o">=</span> <span class="p">[</span><span class="n">fieldType</span><span class="p">]</span>

                <span class="n">simMetaData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simMetaData</span><span class="p">(</span><span class="n">dataKey</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;node&quot;</span> <span class="ow">in</span> <span class="n">fieldType</span> <span class="ow">and</span> <span class="n">simMetaData</span><span class="p">[</span><span class="s1">&#39;nodeData&#39;</span><span class="p">]):</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="p">(</span><span class="s2">&quot;element&quot;</span> <span class="ow">in</span> <span class="n">fieldType</span> <span class="ow">and</span> <span class="n">simMetaData</span><span class="p">[</span><span class="s1">&#39;elmtData&#39;</span><span class="p">]):</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="p">(</span><span class="s2">&quot;grain&quot;</span> <span class="ow">in</span> <span class="n">fieldType</span> <span class="ow">and</span> <span class="n">simMetaData</span><span class="p">[</span><span class="s1">&#39;grainData&#39;</span><span class="p">]):</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:}</span><span class="s2"> data required.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fieldType</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">dataKey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">simDataKeys</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:}</span><span class="s2"> data is not loaded.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataKey</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{:}</span><span class="se">\&quot;</span><span class="s2"> is not available.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataKey</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_validateFrameNums</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frameNums</span><span class="p">):</span>
        <span class="c1"># frameNums: frame or list of frames to run calculation for. -1 for all</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">frameNums</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">frameNums</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">frameNums</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">frameNums</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numFrames</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">frameNums</span> <span class="o">=</span> <span class="p">[</span><span class="n">frameNums</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Only an integer or list allowed for frame nums.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">frameNums</span>

<div class="viewcode-block" id="Mesh.createSimData"><a class="viewcode-back" href="../../defdap.html#defdap.fepx.Mesh.createSimData">[docs]</a>    <span class="k">def</span> <span class="nf">createSimData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataKey</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">isNotVector</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simDataKeysDyn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataKey</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="n">dataKey</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asfortranarray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">isNotVector</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simDataKeysNotVectorDyn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataKey</span><span class="p">)</span></div>

<div class="viewcode-block" id="Mesh.removeSimData"><a class="viewcode-back" href="../../defdap.html#defdap.fepx.Mesh.removeSimData">[docs]</a>    <span class="k">def</span> <span class="nf">removeSimData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataKey</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="n">dataKey</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">dataKey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">simDataKeysDyn</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">simDataKeysDyn</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">dataKey</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dataKey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">simDataKeysNotVectorDyn</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">simDataKeysNotVectorDyn</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">dataKey</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Sim data &#39;</span><span class="si">{:}</span><span class="s2">&#39; not found.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataKey</span><span class="p">))</span></div>

<div class="viewcode-block" id="Mesh.saveArchSimData"><a class="viewcode-back" href="../../defdap.html#defdap.fepx.Mesh.saveArchSimData">[docs]</a>    <span class="k">def</span> <span class="nf">saveArchSimData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataKey</span><span class="p">,</span> <span class="n">saveDir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">os</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="n">dataKey</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Sim data &#39;</span><span class="si">{:}</span><span class="s2">&#39; not found.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataKey</span><span class="p">))</span>

        <span class="c1"># Create save directory if it doesn&#39;t exist</span>
        <span class="k">if</span> <span class="n">saveDir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">saveDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataDir</span> <span class="o">+</span> <span class="s1">&#39;saved_data/&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">saveDir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">saveDir</span><span class="p">)</span>

        <span class="c1"># Save data to file</span>
        <span class="n">fileName</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:}{:}</span><span class="s2">.npz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">saveDir</span><span class="p">,</span> <span class="n">dataKey</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savez_compressed</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="Mesh.loadArchSimData"><a class="viewcode-back" href="../../defdap.html#defdap.fepx.Mesh.loadArchSimData">[docs]</a>    <span class="k">def</span> <span class="nf">loadArchSimData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataKey</span><span class="p">,</span> <span class="n">saveDir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">saveDir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">saveDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataDir</span> <span class="o">+</span> <span class="s1">&#39;saved_data/&#39;</span>

        <span class="c1"># Load from file</span>
        <span class="n">fileName</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:}{:}</span><span class="s2">.npz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">saveDir</span><span class="p">,</span> <span class="n">dataKey</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fileName</span><span class="p">)[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>

        <span class="c1"># doesn&#39;t save the state of isNotVector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">createSimData</span><span class="p">(</span><span class="n">dataKey</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="Mesh.loadFrameData"><a class="viewcode-back" href="../../defdap.html#defdap.fepx.Mesh.loadFrameData">[docs]</a>    <span class="k">def</span> <span class="nf">loadFrameData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataName</span><span class="p">,</span> <span class="n">initialIncd</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">frameNums</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numProcs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numFrames</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numSlipSys</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setSimParams</span><span class="p">(</span><span class="n">numProcs</span><span class="o">=</span><span class="n">numProcs</span><span class="p">,</span> <span class="n">numFrames</span><span class="o">=</span><span class="n">numFrames</span><span class="p">,</span> <span class="n">numSlipSys</span><span class="o">=</span><span class="n">numSlipSys</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">frameNums</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">frameNums</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validateFrameNums</span><span class="p">(</span><span class="n">frameNums</span><span class="p">)</span>
            <span class="n">frameNums</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">initialIncd</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">frameNums</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">frameNums</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">]</span> <span class="o">+</span> <span class="n">frameNums</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initial values must be loaded if available.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">frameNums</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2"> does not include initial data&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataName</span><span class="p">))</span>
                <span class="n">frameNums</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">frameNums</span><span class="p">]</span>

        <span class="c1"># +1 if initial values are also stored</span>
        <span class="n">numFrames</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numFrames</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">initialIncd</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">numFrames</span>
        <span class="n">singleData</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">loadedData</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numProcs</span><span class="p">):</span>
            <span class="c1"># load data per processor</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">post.</span><span class="si">{:s}</span><span class="s2">.</span><span class="si">{:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataDir</span><span class="p">,</span> <span class="n">dataName</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">loadedDataTemp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="s2">&quot;%&quot;</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="n">usecols</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">loadedDataTemp</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># scalar data</span>
                <span class="n">singleData</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># reshape into 2d array with 2nd dim for each frame</span>
                <span class="n">cols</span><span class="p">,</span> <span class="o">=</span> <span class="n">loadedDataTemp</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">perFrame</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cols</span> <span class="o">/</span> <span class="n">numFrames</span><span class="p">)</span>
                <span class="n">loadedDataTemp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">loadedDataTemp</span><span class="p">,</span> <span class="p">(</span><span class="n">perFrame</span><span class="p">,</span> <span class="n">numFrames</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># vector data</span>
                <span class="c1"># reshape into 3d array with 3rd dim for each frame</span>
                <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">loadedDataTemp</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">perFrame</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cols</span> <span class="o">/</span> <span class="n">numFrames</span><span class="p">)</span>
                <span class="n">loadedDataTemp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">loadedDataTemp</span><span class="p">,</span> <span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">perFrame</span><span class="p">,</span> <span class="n">numFrames</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">frameNums</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">loadedDataTemp</span> <span class="o">=</span> <span class="n">loadedDataTemp</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">frameNums</span><span class="p">]</span>
            <span class="n">loadedData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loadedDataTemp</span><span class="p">)</span>

        <span class="c1"># concatenate data from all processors into one array and transpose first 2 axes if vectr data</span>
        <span class="c1"># make data contiguous in memory in column major order</span>
        <span class="k">if</span> <span class="n">singleData</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asfortranarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">loadedData</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asfortranarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">loadedData</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span></div>

<div class="viewcode-block" id="Mesh.loadSimData"><a class="viewcode-back" href="../../defdap.html#defdap.fepx.Mesh.loadSimData">[docs]</a>    <span class="k">def</span> <span class="nf">loadSimData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataKeys</span><span class="p">,</span> <span class="n">forceLoad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">frameNums</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numProcs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numFrames</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numSlipSys</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setSimParams</span><span class="p">(</span><span class="n">numProcs</span><span class="o">=</span><span class="n">numProcs</span><span class="p">,</span> <span class="n">numFrames</span><span class="o">=</span><span class="n">numFrames</span><span class="p">,</span> <span class="n">numSlipSys</span><span class="o">=</span><span class="n">numSlipSys</span><span class="p">)</span>

        <span class="n">simDataLoadFunctions</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;nodePos&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadNodePosData</span><span class="p">,</span>
            <span class="s2">&quot;nodeVel&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadNodeVelData</span><span class="p">,</span>
            <span class="s2">&quot;angle&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadAngleData</span><span class="p">,</span>
            <span class="s2">&quot;hardness&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadHardnessData</span><span class="p">,</span>
            <span class="s2">&quot;strain&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadStrainData</span><span class="p">,</span>
            <span class="s2">&quot;stress&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadStressData</span><span class="p">,</span>
            <span class="s2">&quot;shearRate&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadShearRateData</span><span class="p">,</span>
            <span class="s2">&quot;effDefRate&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadEffDefRateData</span><span class="p">,</span>
            <span class="s2">&quot;effPlasticDefRate&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadEffPlasticDefRateData</span><span class="p">,</span>
            <span class="s2">&quot;eqvStrain&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadEqvStrainData</span><span class="p">,</span>
            <span class="s2">&quot;eqvPlasticStrain&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadEqvPlasticStrainData</span><span class="p">,</span>
            <span class="s2">&quot;backstress&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadBackstressData</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">dataKey</span> <span class="ow">in</span> <span class="n">dataKeys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dataKey</span> <span class="ow">in</span> <span class="n">Mesh</span><span class="o">.</span><span class="n">simDataKeysStatic</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">forceLoad</span> <span class="ow">or</span> <span class="p">(</span><span class="n">dataKey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">):</span>
                    <span class="n">simDataLoadFunctions</span><span class="p">[</span><span class="n">dataKey</span><span class="p">](</span><span class="n">frameNums</span><span class="o">=</span><span class="n">frameNums</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finished loading </span><span class="si">{:}</span><span class="s2"> data.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataKey</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:}</span><span class="s2"> data already loaded.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataKey</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{:}</span><span class="se">\&quot;</span><span class="s2"> is not a valid sim data key.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataKey</span><span class="p">))</span></div>

    <span class="c1"># load node positions for each frame of the simulation</span>
<div class="viewcode-block" id="Mesh.loadNodePosData"><a class="viewcode-back" href="../../defdap.html#defdap.fepx.Mesh.loadNodePosData">[docs]</a>    <span class="k">def</span> <span class="nf">loadNodePosData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frameNums</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numProcs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numFrames</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="s1">&#39;nodePos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadFrameData</span><span class="p">(</span><span class="s2">&quot;adx&quot;</span><span class="p">,</span>
                                                     <span class="kc">True</span><span class="p">,</span>
                                                     <span class="n">frameNums</span><span class="o">=</span><span class="n">frameNums</span><span class="p">,</span>
                                                     <span class="n">numProcs</span><span class="o">=</span><span class="n">numProcs</span><span class="p">,</span>
                                                     <span class="n">numFrames</span><span class="o">=</span><span class="n">numFrames</span><span class="p">)</span></div>

<div class="viewcode-block" id="Mesh.loadNodeVelData"><a class="viewcode-back" href="../../defdap.html#defdap.fepx.Mesh.loadNodeVelData">[docs]</a>    <span class="k">def</span> <span class="nf">loadNodeVelData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frameNums</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numProcs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numFrames</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="s1">&#39;nodeVel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadFrameData</span><span class="p">(</span><span class="s2">&quot;advel&quot;</span><span class="p">,</span>
                                                     <span class="kc">True</span><span class="p">,</span>
                                                     <span class="n">frameNums</span><span class="o">=</span><span class="n">frameNums</span><span class="p">,</span>
                                                     <span class="n">numProcs</span><span class="o">=</span><span class="n">numProcs</span><span class="p">,</span>
                                                     <span class="n">numFrames</span><span class="o">=</span><span class="n">numFrames</span><span class="p">)</span></div>

<div class="viewcode-block" id="Mesh.loadAngleData"><a class="viewcode-back" href="../../defdap.html#defdap.fepx.Mesh.loadAngleData">[docs]</a>    <span class="k">def</span> <span class="nf">loadAngleData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frameNums</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numProcs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numFrames</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="s1">&#39;angle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadFrameData</span><span class="p">(</span><span class="s2">&quot;ang&quot;</span><span class="p">,</span>
                                                   <span class="kc">True</span><span class="p">,</span>
                                                   <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
                                                   <span class="n">frameNums</span><span class="o">=</span><span class="n">frameNums</span><span class="p">,</span>
                                                   <span class="n">numProcs</span><span class="o">=</span><span class="n">numProcs</span><span class="p">,</span>
                                                   <span class="n">numFrames</span><span class="o">=</span><span class="n">numFrames</span><span class="p">)</span>

        <span class="c1"># Covert to Bunge rep. in radians (were Kocks in degrees)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="s1">&#39;angle&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="s1">&#39;angle&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="s1">&#39;angle&#39;</span><span class="p">][:,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="s1">&#39;angle&#39;</span><span class="p">][:,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="n">oriData</span> <span class="o">=</span> <span class="n">Quat</span><span class="o">.</span><span class="n">createManyQuats</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="s1">&#39;angle&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">createSimData</span><span class="p">(</span><span class="s2">&quot;ori&quot;</span><span class="p">,</span> <span class="n">oriData</span><span class="p">)</span></div>

<div class="viewcode-block" id="Mesh.loadHardnessData"><a class="viewcode-back" href="../../defdap.html#defdap.fepx.Mesh.loadHardnessData">[docs]</a>    <span class="k">def</span> <span class="nf">loadHardnessData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frameNums</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numProcs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numFrames</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numSlipSys</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="s1">&#39;hardness&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadFrameData</span><span class="p">(</span><span class="s2">&quot;crss&quot;</span><span class="p">,</span>
                                                      <span class="kc">True</span><span class="p">,</span>
                                                      <span class="n">frameNums</span><span class="o">=</span><span class="n">frameNums</span><span class="p">,</span>
                                                      <span class="n">numProcs</span><span class="o">=</span><span class="n">numProcs</span><span class="p">,</span>
                                                      <span class="n">numFrames</span><span class="o">=</span><span class="n">numFrames</span><span class="p">,</span>
                                                      <span class="n">numSlipSys</span><span class="o">=</span><span class="n">numSlipSys</span><span class="p">)</span></div>

<div class="viewcode-block" id="Mesh.loadStrainData"><a class="viewcode-back" href="../../defdap.html#defdap.fepx.Mesh.loadStrainData">[docs]</a>    <span class="k">def</span> <span class="nf">loadStrainData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frameNums</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numProcs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numFrames</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="s1">&#39;strain&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadFrameData</span><span class="p">(</span><span class="s2">&quot;strain&quot;</span><span class="p">,</span>
                                                    <span class="kc">False</span><span class="p">,</span>
                                                    <span class="n">frameNums</span><span class="o">=</span><span class="n">frameNums</span><span class="p">,</span>
                                                    <span class="n">numProcs</span><span class="o">=</span><span class="n">numProcs</span><span class="p">,</span>
                                                    <span class="n">numFrames</span><span class="o">=</span><span class="n">numFrames</span><span class="p">)</span></div>

<div class="viewcode-block" id="Mesh.loadStressData"><a class="viewcode-back" href="../../defdap.html#defdap.fepx.Mesh.loadStressData">[docs]</a>    <span class="k">def</span> <span class="nf">loadStressData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frameNums</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numProcs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numFrames</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="s1">&#39;stress&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadFrameData</span><span class="p">(</span><span class="s2">&quot;stress&quot;</span><span class="p">,</span>
                                                    <span class="kc">False</span><span class="p">,</span>
                                                    <span class="n">frameNums</span><span class="o">=</span><span class="n">frameNums</span><span class="p">,</span>
                                                    <span class="n">numProcs</span><span class="o">=</span><span class="n">numProcs</span><span class="p">,</span>
                                                    <span class="n">numFrames</span><span class="o">=</span><span class="n">numFrames</span><span class="p">)</span></div>

<div class="viewcode-block" id="Mesh.loadShearRateData"><a class="viewcode-back" href="../../defdap.html#defdap.fepx.Mesh.loadShearRateData">[docs]</a>    <span class="k">def</span> <span class="nf">loadShearRateData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frameNums</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numProcs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numFrames</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numSlipSys</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="s1">&#39;shearRate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadFrameData</span><span class="p">(</span><span class="s2">&quot;gammadot&quot;</span><span class="p">,</span>
                                                       <span class="kc">False</span><span class="p">,</span>
                                                       <span class="n">frameNums</span><span class="o">=</span><span class="n">frameNums</span><span class="p">,</span>
                                                       <span class="n">numProcs</span><span class="o">=</span><span class="n">numProcs</span><span class="p">,</span>
                                                       <span class="n">numFrames</span><span class="o">=</span><span class="n">numFrames</span><span class="p">,</span>
                                                       <span class="n">numSlipSys</span><span class="o">=</span><span class="n">numSlipSys</span><span class="p">)</span></div>

<div class="viewcode-block" id="Mesh.loadEffDefRateData"><a class="viewcode-back" href="../../defdap.html#defdap.fepx.Mesh.loadEffDefRateData">[docs]</a>    <span class="k">def</span> <span class="nf">loadEffDefRateData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frameNums</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numProcs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numFrames</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="s1">&#39;effDefRate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadFrameData</span><span class="p">(</span><span class="s2">&quot;deff&quot;</span><span class="p">,</span>
                                                        <span class="kc">False</span><span class="p">,</span>
                                                        <span class="n">frameNums</span><span class="o">=</span><span class="n">frameNums</span><span class="p">,</span>
                                                        <span class="n">numProcs</span><span class="o">=</span><span class="n">numProcs</span><span class="p">,</span>
                                                        <span class="n">numFrames</span><span class="o">=</span><span class="n">numFrames</span><span class="p">)</span></div>

<div class="viewcode-block" id="Mesh.loadEffPlasticDefRateData"><a class="viewcode-back" href="../../defdap.html#defdap.fepx.Mesh.loadEffPlasticDefRateData">[docs]</a>    <span class="k">def</span> <span class="nf">loadEffPlasticDefRateData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frameNums</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numProcs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numFrames</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="s1">&#39;effPlasticDefRate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadFrameData</span><span class="p">(</span><span class="s2">&quot;dpeff&quot;</span><span class="p">,</span>
                                                               <span class="kc">False</span><span class="p">,</span>
                                                               <span class="n">frameNums</span><span class="o">=</span><span class="n">frameNums</span><span class="p">,</span>
                                                               <span class="n">numProcs</span><span class="o">=</span><span class="n">numProcs</span><span class="p">,</span>
                                                               <span class="n">numFrames</span><span class="o">=</span><span class="n">numFrames</span><span class="p">)</span></div>

<div class="viewcode-block" id="Mesh.loadEqvStrainData"><a class="viewcode-back" href="../../defdap.html#defdap.fepx.Mesh.loadEqvStrainData">[docs]</a>    <span class="k">def</span> <span class="nf">loadEqvStrainData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frameNums</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numProcs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numFrames</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="s1">&#39;eqvStrain&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadFrameData</span><span class="p">(</span><span class="s2">&quot;eqstrain&quot;</span><span class="p">,</span>
                                                       <span class="kc">False</span><span class="p">,</span>
                                                       <span class="n">frameNums</span><span class="o">=</span><span class="n">frameNums</span><span class="p">,</span>
                                                       <span class="n">numProcs</span><span class="o">=</span><span class="n">numProcs</span><span class="p">,</span>
                                                       <span class="n">numFrames</span><span class="o">=</span><span class="n">numFrames</span><span class="p">)</span></div>

<div class="viewcode-block" id="Mesh.loadEqvPlasticStrainData"><a class="viewcode-back" href="../../defdap.html#defdap.fepx.Mesh.loadEqvPlasticStrainData">[docs]</a>    <span class="k">def</span> <span class="nf">loadEqvPlasticStrainData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frameNums</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numProcs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numFrames</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="s1">&#39;eqvPlasticStrain&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadFrameData</span><span class="p">(</span><span class="s2">&quot;eqplstrain&quot;</span><span class="p">,</span>
                                                              <span class="kc">False</span><span class="p">,</span>
                                                              <span class="n">frameNums</span><span class="o">=</span><span class="n">frameNums</span><span class="p">,</span>
                                                              <span class="n">numProcs</span><span class="o">=</span><span class="n">numProcs</span><span class="p">,</span>
                                                              <span class="n">numFrames</span><span class="o">=</span><span class="n">numFrames</span><span class="p">)</span></div>

<div class="viewcode-block" id="Mesh.loadBackstressData"><a class="viewcode-back" href="../../defdap.html#defdap.fepx.Mesh.loadBackstressData">[docs]</a>    <span class="k">def</span> <span class="nf">loadBackstressData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frameNums</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numProcs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numFrames</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="s1">&#39;backstress&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadFrameData</span><span class="p">(</span><span class="s2">&quot;backstress&quot;</span><span class="p">,</span>
                                                        <span class="kc">False</span><span class="p">,</span>
                                                        <span class="n">frameNums</span><span class="o">=</span><span class="n">frameNums</span><span class="p">,</span>
                                                        <span class="n">numProcs</span><span class="o">=</span><span class="n">numProcs</span><span class="p">,</span>
                                                        <span class="n">numFrames</span><span class="o">=</span><span class="n">numFrames</span><span class="p">)</span></div>

<div class="viewcode-block" id="Mesh.loadMeshElStatsData"><a class="viewcode-back" href="../../defdap.html#defdap.fepx.Mesh.loadMeshElStatsData">[docs]</a>    <span class="k">def</span> <span class="nf">loadMeshElStatsData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="c1"># open mesh stats file</span>
        <span class="n">ELSTAT_FILE_EX</span> <span class="o">=</span> <span class="s2">&quot;stelt3d&quot;</span>
        <span class="n">fileName</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}{:s}</span><span class="s2">.</span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meshDir</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ELSTAT_FILE_EX</span><span class="p">)</span>
        <span class="n">elStatFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>

        <span class="c1"># read grain and phase info for each element</span>
        <span class="n">elStats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">elStatFile</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">elStats</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">numElmts</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Problem with element stats file. Missing element data.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elStats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asfortranarray</span><span class="p">(</span><span class="n">elStats</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">meshElStatNames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ID&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;coord-x&quot;</span><span class="p">,</span> <span class="s2">&quot;coord-y&quot;</span><span class="p">,</span> <span class="s2">&quot;coord-z&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;elset (grains)&quot;</span><span class="p">,</span> <span class="s2">&quot;partition&quot;</span><span class="p">,</span> <span class="s2">&quot;volume&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;2dmeshp-x&quot;</span><span class="p">,</span> <span class="s2">&quot;2dmeshp-y&quot;</span><span class="p">,</span> <span class="s2">&quot;2dmeshp-z&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;2dmeshd&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;2dmeshv-x&quot;</span><span class="p">,</span> <span class="s2">&quot;2dmeshv-y&quot;</span><span class="p">,</span> <span class="s2">&quot;2dmeshv-z&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;2dmeshn-x&quot;</span><span class="p">,</span> <span class="s2">&quot;2dmeshn-y&quot;</span><span class="p">,</span> <span class="s2">&quot;2dmeshn-z&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="Mesh.calcMeshSize"><a class="viewcode-back" href="../../defdap.html#defdap.fepx.Mesh.calcMeshSize">[docs]</a>    <span class="k">def</span> <span class="nf">calcMeshSize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">maxNodePos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodePos</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">minNodePos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodePos</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">meshSize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">maxNodePos</span> <span class="o">-</span> <span class="n">minNodePos</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">meshSize</span></div>

<div class="viewcode-block" id="Mesh.constructVtkMesh"><a class="viewcode-back" href="../../defdap.html#defdap.fepx.Mesh.constructVtkMesh">[docs]</a>    <span class="k">def</span> <span class="nf">constructVtkMesh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create VTK mesh using initial (undeformaed) node positions</span>

<span class="sd">        Returns:</span>
<span class="sd">            vtkUnstructuredGrid: VTK mesh</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">CON_ORDER</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>  <span class="c1"># corners, then midpoints</span>
        <span class="n">ELMT_TYPE</span> <span class="o">=</span> <span class="mi">24</span>

        <span class="c1"># create vtk point array for node positions</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPoints</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodePos</span><span class="p">:</span>
            <span class="n">points</span><span class="o">.</span><span class="n">InsertNextPoint</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>

        <span class="c1"># create vtk unstructured grid and assign point array</span>
        <span class="n">uGrid</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkUnstructuredGrid</span><span class="p">()</span>
        <span class="n">uGrid</span><span class="o">.</span><span class="n">SetPoints</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>

        <span class="c1"># add cells to unstructured grid</span>
        <span class="n">con</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkIdList</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">elmtCon</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elmtCon</span><span class="p">:</span>
            <span class="n">con</span><span class="o">.</span><span class="n">Reset</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">pointID</span> <span class="ow">in</span> <span class="n">elmtCon</span><span class="p">[</span><span class="n">CON_ORDER</span><span class="p">]:</span>
                <span class="n">con</span><span class="o">.</span><span class="n">InsertNextId</span><span class="p">(</span><span class="n">pointID</span><span class="p">)</span>

            <span class="n">uGrid</span><span class="o">.</span><span class="n">InsertNextCell</span><span class="p">(</span><span class="n">ELMT_TYPE</span><span class="p">,</span> <span class="n">con</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">uGrid</span></div>

<div class="viewcode-block" id="Mesh.calcGradient"><a class="viewcode-back" href="../../defdap.html#defdap.fepx.Mesh.calcGradient">[docs]</a>    <span class="k">def</span> <span class="nf">calcGradient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inDataKey</span><span class="p">,</span> <span class="n">outDataKey</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate gradient of simulation data wrt initial coordinates</span>

<span class="sd">        Args:</span>
<span class="sd">            inDataKey (string): Sim data key to caluclate gradient of</span>
<span class="sd">            outDataKey (string): Sim data key to store result</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># validate input data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validateSimDataKey</span><span class="p">(</span><span class="n">inDataKey</span><span class="p">,</span> <span class="n">fieldType</span><span class="o">=</span><span class="s2">&quot;node&quot;</span><span class="p">)</span>

        <span class="c1"># create array to store gradient</span>
        <span class="n">simMetaData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simMetaData</span><span class="p">(</span><span class="n">inDataKey</span><span class="p">)</span>
        <span class="n">inDataShape</span> <span class="o">=</span> <span class="n">simMetaData</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">simMetaData</span><span class="p">[</span><span class="s1">&#39;numComponents&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">gradient</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">inDataShape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="n">inDataShape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gradient</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">inDataShape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">inDataShape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">inDataShape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

        <span class="c1"># create VTK mesh</span>
        <span class="n">uGrid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constructVtkMesh</span><span class="p">()</span>

        <span class="n">numFrames</span> <span class="o">=</span> <span class="n">inDataShape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numFrames</span><span class="p">):</span>
            <span class="c1"># add point data to unstructured grid</span>
            <span class="n">vtkData</span> <span class="o">=</span> <span class="n">vnp</span><span class="o">.</span><span class="n">numpy_to_vtk</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="n">inDataKey</span><span class="p">][</span><span class="o">...</span><span class="p">,</span> <span class="n">i</span><span class="p">]))</span>
            <span class="n">vtkData</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="n">inDataKey</span><span class="p">)</span>
            <span class="n">uGrid</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">vtkData</span><span class="p">);</span>

            <span class="c1"># apply vtk gradient filter</span>
            <span class="n">gradFilter</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkGradientFilter</span><span class="p">()</span>
            <span class="n">gradFilter</span><span class="o">.</span><span class="n">SetInputDataObject</span><span class="p">(</span><span class="n">uGrid</span><span class="p">)</span>
            <span class="n">gradFilter</span><span class="o">.</span><span class="n">SetInputScalars</span><span class="p">(</span><span class="n">vtk</span><span class="o">.</span><span class="n">vtkDataObject</span><span class="o">.</span><span class="n">FIELD_ASSOCIATION_POINTS</span><span class="p">,</span> <span class="n">inDataKey</span><span class="p">)</span>
            <span class="n">gradFilter</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

            <span class="c1"># collect output</span>
            <span class="n">gradient</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vnp</span><span class="o">.</span><span class="n">vtk_to_numpy</span><span class="p">(</span>
                <span class="n">gradFilter</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="s1">&#39;Gradients&#39;</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># Garbage collection before next frame</span>
            <span class="n">gradFilter</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">uGrid</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">RemoveArray</span><span class="p">(</span><span class="n">inDataKey</span><span class="p">);</span>
            <span class="n">vtkData</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">createSimData</span><span class="p">(</span><span class="n">outDataKey</span><span class="p">,</span> <span class="n">gradient</span><span class="p">)</span></div>

<div class="viewcode-block" id="Mesh.nodeToElmtData"><a class="viewcode-back" href="../../defdap.html#defdap.fepx.Mesh.nodeToElmtData">[docs]</a>    <span class="k">def</span> <span class="nf">nodeToElmtData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inDataKey</span><span class="p">,</span> <span class="n">outDataKey</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert node data to element data using VTK framework</span>

<span class="sd">        Args:</span>
<span class="sd">            inDataKey (string): Sim data key to convert</span>
<span class="sd">            outDataKey (string): Sim data key to store result</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># validate input data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validateSimDataKey</span><span class="p">(</span><span class="n">inDataKey</span><span class="p">,</span> <span class="n">fieldType</span><span class="o">=</span><span class="s2">&quot;node&quot;</span><span class="p">)</span>

        <span class="c1"># create array to store element data</span>
        <span class="n">simMetaData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simMetaData</span><span class="p">(</span><span class="n">inDataKey</span><span class="p">)</span>
        <span class="n">inDataShape</span> <span class="o">=</span> <span class="n">simMetaData</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span>
        <span class="n">elmtData</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">numElmts</span><span class="p">,)</span> <span class="o">+</span> <span class="n">inDataShape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

        <span class="c1"># create VTK mesh</span>
        <span class="n">uGrid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constructVtkMesh</span><span class="p">()</span>

        <span class="n">numFrames</span> <span class="o">=</span> <span class="n">inDataShape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numFrames</span><span class="p">):</span>
            <span class="c1"># add point data to unstructured grid</span>
            <span class="n">vtkData</span> <span class="o">=</span> <span class="n">vnp</span><span class="o">.</span><span class="n">numpy_to_vtk</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="n">inDataKey</span><span class="p">][</span><span class="o">...</span><span class="p">,</span> <span class="n">i</span><span class="p">]))</span>
            <span class="n">vtkData</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="n">inDataKey</span><span class="p">)</span>
            <span class="n">uGrid</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">vtkData</span><span class="p">);</span>

            <span class="c1"># apply point to cell data fiter</span>
            <span class="n">conversionFilter</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPointDataToCellData</span><span class="p">()</span>
            <span class="n">conversionFilter</span><span class="o">.</span><span class="n">SetInputDataObject</span><span class="p">(</span><span class="n">uGrid</span><span class="p">)</span>
            <span class="n">conversionFilter</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

            <span class="c1"># collect output</span>
            <span class="n">elmtData</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vnp</span><span class="o">.</span><span class="n">vtk_to_numpy</span><span class="p">(</span>
                <span class="n">conversionFilter</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">inDataKey</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># Garbage collection before next frame</span>
            <span class="n">conversionFilter</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">uGrid</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">RemoveArray</span><span class="p">(</span><span class="n">inDataKey</span><span class="p">);</span>
            <span class="n">uGrid</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">RemoveArray</span><span class="p">(</span><span class="n">inDataKey</span><span class="p">);</span>
            <span class="n">vtkData</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">createSimData</span><span class="p">(</span><span class="n">outDataKey</span><span class="p">,</span> <span class="n">elmtData</span><span class="p">)</span></div>

<div class="viewcode-block" id="Mesh.calcMisori"><a class="viewcode-back" href="../../defdap.html#defdap.fepx.Mesh.calcMisori">[docs]</a>    <span class="k">def</span> <span class="nf">calcMisori</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frameNums</span><span class="p">):</span>
        <span class="n">frameNums</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validateFrameNums</span><span class="p">(</span><span class="n">frameNums</span><span class="p">)</span>

        <span class="c1"># create arrays to store misori data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">createSimData</span><span class="p">(</span><span class="s2">&quot;misOri&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="s1">&#39;ori&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">createSimData</span><span class="p">(</span><span class="s2">&quot;avMisOri&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">numGrains</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="s1">&#39;ori&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">createSimData</span><span class="p">(</span><span class="s2">&quot;maxMisOri&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">numGrains</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="s1">&#39;ori&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">createSimData</span><span class="p">(</span><span class="s2">&quot;avOri&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">numGrains</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="s1">&#39;ori&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">Quat</span><span class="p">))</span>

        <span class="n">symmetry</span> <span class="o">=</span> <span class="s1">&#39;cubic&#39;</span>
        <span class="c1"># Loop over frames</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">frameNum</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">frameNums</span><span class="p">):</span>
            <span class="c1"># Loop over grains</span>
            <span class="k">for</span> <span class="n">grainID</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numGrains</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="c1"># select grains based on grainID</span>
                <span class="n">selected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elmtGrain</span> <span class="o">==</span> <span class="n">grainID</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">quats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="s1">&#39;ori&#39;</span><span class="p">][</span><span class="n">selected</span><span class="p">,</span> <span class="n">frameNum</span><span class="p">]</span>

                <span class="n">quatCompsSym</span> <span class="o">=</span> <span class="n">Quat</span><span class="o">.</span><span class="n">calcSymEqvs</span><span class="p">(</span><span class="n">quats</span><span class="p">,</span> <span class="n">symmetry</span><span class="p">)</span>

                <span class="n">averageOri</span> <span class="o">=</span> <span class="n">Quat</span><span class="o">.</span><span class="n">calcAverageOri</span><span class="p">(</span><span class="n">quatCompsSym</span><span class="p">)</span>

                <span class="n">misOriArray</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">Quat</span><span class="o">.</span><span class="n">calcMisOri</span><span class="p">(</span><span class="n">quatCompsSym</span><span class="p">,</span> <span class="n">averageOri</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="s1">&#39;misOri&#39;</span><span class="p">][</span><span class="n">selected</span><span class="p">,</span> <span class="n">frameNum</span><span class="p">]</span> <span class="o">=</span> <span class="n">misOriArray</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="s1">&#39;avMisOri&#39;</span><span class="p">][</span><span class="n">grainID</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">frameNum</span><span class="p">]</span> <span class="o">=</span> <span class="n">misOriArray</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="s1">&#39;maxMisOri&#39;</span><span class="p">][</span><span class="n">grainID</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">frameNum</span><span class="p">]</span> <span class="o">=</span> <span class="n">misOriArray</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="s1">&#39;avOri&#39;</span><span class="p">][</span><span class="n">grainID</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">frameNum</span><span class="p">]</span> <span class="o">=</span> <span class="n">averageOri</span>

            <span class="n">clear_output</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Frame </span><span class="si">{:d}</span><span class="s2"> of </span><span class="si">{:d}</span><span class="s2"> done.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">frameNums</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="s1">&#39;misOri&#39;</span><span class="p">][:,</span> <span class="n">frameNums</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="s1">&#39;misOri&#39;</span><span class="p">][:,</span> <span class="n">frameNums</span><span class="p">])</span> <span class="o">*</span> <span class="mi">360</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="s1">&#39;avMisOri&#39;</span><span class="p">][:,</span> <span class="n">frameNums</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="s1">&#39;avMisOri&#39;</span><span class="p">][:,</span> <span class="n">frameNums</span><span class="p">])</span> <span class="o">*</span> <span class="mi">360</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="s1">&#39;maxMisOri&#39;</span><span class="p">][:,</span> <span class="n">frameNums</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="s1">&#39;maxMisOri&#39;</span><span class="p">][:,</span> <span class="n">frameNums</span><span class="p">])</span> <span class="o">*</span> <span class="mi">360</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span></div>

<div class="viewcode-block" id="Mesh.calcGrainAverage"><a class="viewcode-back" href="../../defdap.html#defdap.fepx.Mesh.calcGrainAverage">[docs]</a>    <span class="k">def</span> <span class="nf">calcGrainAverage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inDataKey</span><span class="p">,</span> <span class="n">outDataKey</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate grain avergae of elemnet data.</span>

<span class="sd">        Args:</span>
<span class="sd">            inDataKey (str): Data key of input data</span>
<span class="sd">            outDataKey (None, optional): Data key to save data to. If none given then the data is returned from the function</span>

<span class="sd">        Returns:</span>
<span class="sd">            Array: Grain average data or nothing if outDataKey specified.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># validate input data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validateSimDataKey</span><span class="p">(</span><span class="n">inDataKey</span><span class="p">,</span> <span class="n">fieldType</span><span class="o">=</span><span class="s2">&quot;element&quot;</span><span class="p">)</span>

        <span class="n">inMetaData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simMetaData</span><span class="p">(</span><span class="n">inDataKey</span><span class="p">)</span>
        <span class="n">outDataShape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numGrains</span><span class="p">,)</span> <span class="o">+</span> <span class="n">inMetaData</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>

        <span class="n">grainData</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">outDataShape</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numGrains</span><span class="p">):</span>
            <span class="n">grainData</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="n">inDataKey</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">elmtGrain</span> <span class="o">==</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">outDataKey</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">grainData</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">createSimData</span><span class="p">(</span><span class="n">outDataKey</span><span class="p">,</span> <span class="n">grainData</span><span class="p">,</span> <span class="n">isNotVector</span><span class="o">=</span><span class="n">inMetaData</span><span class="p">[</span><span class="s1">&#39;notVector&#39;</span><span class="p">])</span>
            <span class="k">return</span></div>

<div class="viewcode-block" id="Mesh.writeVTU"><a class="viewcode-back" href="../../defdap.html#defdap.fepx.Mesh.writeVTU">[docs]</a>    <span class="k">def</span> <span class="nf">writeVTU</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span> <span class="n">frameNums</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">useInitialNodePos</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write data out to VTK compatible files. Files are output to the data directory.</span>

<span class="sd">        Args:</span>
<span class="sd">            fileName (string): Base name of output files.</span>
<span class="sd">            frameNums (lst(int)): The simlation frames to output. Either an integer for a single</span>
<span class="sd">                                  frame, a list of ints for many or -1 for all. 0 is intial and 1 is first sim output</span>
<span class="sd">            outputs (list(string)): The properties to be output. Current options are misOri, gammadot,</span>
<span class="sd">                                    backstress and elStats.</span>
<span class="sd">            times (list(float), optional): The time at each frame (only used for labeling)</span>
<span class="sd">            useInitialNodePos (bool, optional): If false uses updateded node positions from each frame. Default: True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Constants</span>
        <span class="n">CON_ORDER</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>  <span class="c1"># corners, then midpoints</span>
        <span class="n">ELMT_TYPE</span> <span class="o">=</span> <span class="mi">24</span>
        <span class="n">FILE_POSTFIX</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># create arrays for element type, conneectivity offset and node positions</span>
        <span class="n">cell_types</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numElmts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
        <span class="c1"># cell_types[:] = pyevtk.vtk.VtkQuadraticTetra.tid</span>
        <span class="n">cell_types</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">ELMT_TYPE</span>

        <span class="n">offsets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="mi">10</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numElmts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">step</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">useInitialNodePos</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodePos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodePos</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodePos</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>

        <span class="c1"># check frameNums and times are valid</span>
        <span class="n">frameNums</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validateFrameNums</span><span class="p">(</span><span class="n">frameNums</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">times</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">times</span> <span class="o">=</span> <span class="n">frameNums</span>

        <span class="c1"># validate outputs</span>
        <span class="n">includeElStats</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># list of tuples includng validated name, if includes initial data,</span>
        <span class="c1"># number of data fields and if nodal or elemental data (true for nodal)</span>
        <span class="n">simMetaDatas</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dataKey</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dataKey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">:</span>
                <span class="c1"># add metadata to list. node data fields to the start and element data fields to the end</span>
                <span class="n">simMetaData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simMetaData</span><span class="p">(</span><span class="n">dataKey</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">simMetaData</span><span class="p">[</span><span class="s1">&#39;nodeData&#39;</span><span class="p">]:</span>
                    <span class="n">simMetaDatas</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">simMetaData</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">simMetaDatas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">simMetaData</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">dataKey</span> <span class="o">==</span> <span class="s2">&quot;elStats&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">elStats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">includeElStats</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Element stats have not been loaded&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">dataKey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">simDataKeys</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:}</span><span class="s2"> data is not loaded.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataKey</span><span class="p">))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{:}</span><span class="se">\&quot;</span><span class="s2"> is not a valid output data key.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataKey</span><span class="p">))</span>

        <span class="c1"># open vtk group file</span>
        <span class="n">fileNameFull</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}{:s}{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataDir</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span> <span class="n">FILE_POSTFIX</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">fileNameFull</span><span class="p">)</span>
        <span class="n">vtgFile</span> <span class="o">=</span> <span class="n">pyevtk</span><span class="o">.</span><span class="n">vtk</span><span class="o">.</span><span class="n">VtkGroup</span><span class="p">(</span><span class="n">fileNameFull</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">frameNum</span> <span class="ow">in</span> <span class="n">frameNums</span><span class="p">:</span>
            <span class="c1"># write frame vtu file path to vtk group file (this needed modification to</span>
            <span class="c1"># evtk module to write paths not relative to the current working directory)</span>
            <span class="n">fileNameFull</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}{:s}</span><span class="s2">.</span><span class="si">{:d}</span><span class="s2">.vtu&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">FILE_POSTFIX</span><span class="p">,</span> <span class="n">frameNum</span><span class="p">)</span>
            <span class="n">vtgFile</span><span class="o">.</span><span class="n">addFile</span><span class="p">(</span><span class="n">fileNameFull</span><span class="p">,</span> <span class="n">times</span><span class="p">[</span><span class="n">frameNum</span><span class="p">],</span> <span class="n">relToCWD</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># open vtu file and write root elements (node positions, element connectivity and type)</span>
            <span class="n">fileNameFull</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}{:s}{:s}</span><span class="s2">.</span><span class="si">{:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataDir</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span> <span class="n">FILE_POSTFIX</span><span class="p">,</span> <span class="n">frameNum</span><span class="p">)</span>
            <span class="n">vtuFile</span> <span class="o">=</span> <span class="n">pyevtk</span><span class="o">.</span><span class="n">vtk</span><span class="o">.</span><span class="n">VtkFile</span><span class="p">(</span><span class="n">fileNameFull</span><span class="p">,</span> <span class="n">pyevtk</span><span class="o">.</span><span class="n">vtk</span><span class="o">.</span><span class="n">VtkUnstructuredGrid</span><span class="p">)</span>
            <span class="n">vtuFile</span><span class="o">.</span><span class="n">openGrid</span><span class="p">()</span>
            <span class="n">vtuFile</span><span class="o">.</span><span class="n">openPiece</span><span class="p">(</span><span class="n">ncells</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">numElmts</span><span class="p">,</span> <span class="n">npoints</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">numNodes</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">useInitialNodePos</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="s1">&#39;nodePos&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">frameNum</span><span class="p">]</span>
                <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="s1">&#39;nodePos&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">frameNum</span><span class="p">]</span>
                <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="s1">&#39;nodePos&#39;</span><span class="p">][:,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">frameNum</span><span class="p">]</span>

            <span class="n">vtuFile</span><span class="o">.</span><span class="n">openElement</span><span class="p">(</span><span class="s2">&quot;Points&quot;</span><span class="p">)</span>
            <span class="n">vtuFile</span><span class="o">.</span><span class="n">addData</span><span class="p">(</span><span class="s2">&quot;points&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span>
            <span class="n">vtuFile</span><span class="o">.</span><span class="n">closeElement</span><span class="p">(</span><span class="s2">&quot;Points&quot;</span><span class="p">)</span>

            <span class="n">vtuFile</span><span class="o">.</span><span class="n">openElement</span><span class="p">(</span><span class="s2">&quot;Cells&quot;</span><span class="p">)</span>
            <span class="c1"># vtuFile.addData(&quot;connectivity&quot;, self.elmtCon.flatten())</span>
            <span class="n">vtuFile</span><span class="o">.</span><span class="n">addHeader</span><span class="p">(</span><span class="s2">&quot;connectivity&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elmtCon</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elmtCon</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">vtuFile</span><span class="o">.</span><span class="n">addData</span><span class="p">(</span><span class="s2">&quot;offsets&quot;</span><span class="p">,</span> <span class="n">offsets</span><span class="p">)</span>
            <span class="n">vtuFile</span><span class="o">.</span><span class="n">addData</span><span class="p">(</span><span class="s2">&quot;types&quot;</span><span class="p">,</span> <span class="n">cell_types</span><span class="p">)</span>
            <span class="n">vtuFile</span><span class="o">.</span><span class="n">closeElement</span><span class="p">(</span><span class="s2">&quot;Cells&quot;</span><span class="p">)</span>

            <span class="c1"># Add headers of simulation point data</span>
            <span class="n">vtuFile</span><span class="o">.</span><span class="n">openElement</span><span class="p">(</span><span class="s2">&quot;PointData&quot;</span><span class="p">)</span>

            <span class="c1"># loop over outputs adding headers if node data</span>
            <span class="k">for</span> <span class="n">simMetaData</span> <span class="ow">in</span> <span class="n">simMetaDatas</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">simMetaData</span><span class="p">[</span><span class="s1">&#39;includesInitial&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="p">(</span><span class="n">frameNum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="ow">and</span> <span class="n">simMetaData</span><span class="p">[</span><span class="s1">&#39;nodeData&#39;</span><span class="p">]:</span>
                    <span class="n">dataKey</span> <span class="o">=</span> <span class="n">simMetaData</span><span class="p">[</span><span class="s1">&#39;dataKey&#39;</span><span class="p">]</span>
                    <span class="n">trueFrameNum</span> <span class="o">=</span> <span class="n">frameNum</span> <span class="k">if</span> <span class="n">simMetaData</span><span class="p">[</span><span class="s1">&#39;includesInitial&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="n">frameNum</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="c1"># check if single or multiple variable output</span>
                    <span class="k">if</span> <span class="n">simMetaData</span><span class="p">[</span><span class="s1">&#39;numComponents&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># add single header to file</span>
                        <span class="n">vtuFile</span><span class="o">.</span><span class="n">addHeader</span><span class="p">(</span>
                            <span class="n">dataKey</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="n">dataKey</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="n">dataKey</span><span class="p">][:,</span> <span class="n">trueFrameNum</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                            <span class="mi">1</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">simMetaData</span><span class="p">[</span><span class="s1">&#39;numComponents&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">dataKey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">simDataKeysNotVector</span><span class="p">):</span>
                        <span class="c1"># add single header to file with 3 components for vector</span>
                        <span class="n">vtuFile</span><span class="o">.</span><span class="n">addHeader</span><span class="p">(</span>
                            <span class="n">dataKey</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="n">dataKey</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="n">dataKey</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">trueFrameNum</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                            <span class="mi">3</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># add multiple headers to file</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">simMetaData</span><span class="p">[</span><span class="s1">&#39;numComponents&#39;</span><span class="p">]):</span>
                            <span class="n">vtuFile</span><span class="o">.</span><span class="n">addHeader</span><span class="p">(</span>
                                <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2"> </span><span class="si">{:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataKey</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="n">dataKey</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="n">dataKey</span><span class="p">][:,</span> <span class="n">i</span><span class="p">,</span> <span class="n">trueFrameNum</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                                <span class="mi">1</span>
                            <span class="p">)</span>

            <span class="n">vtuFile</span><span class="o">.</span><span class="n">closeElement</span><span class="p">(</span><span class="s2">&quot;PointData&quot;</span><span class="p">)</span>

            <span class="c1"># Add headers of simulation cell data</span>
            <span class="n">vtuFile</span><span class="o">.</span><span class="n">openElement</span><span class="p">(</span><span class="s2">&quot;CellData&quot;</span><span class="p">)</span>

            <span class="c1"># loop over outputs adding headers if element data</span>
            <span class="k">for</span> <span class="n">simMetaData</span> <span class="ow">in</span> <span class="n">simMetaDatas</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">simMetaData</span><span class="p">[</span><span class="s1">&#39;includesInitial&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="p">(</span><span class="n">frameNum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="ow">and</span> <span class="n">simMetaData</span><span class="p">[</span><span class="s1">&#39;elmtData&#39;</span><span class="p">]:</span>
                    <span class="n">dataKey</span> <span class="o">=</span> <span class="n">simMetaData</span><span class="p">[</span><span class="s1">&#39;dataKey&#39;</span><span class="p">]</span>
                    <span class="n">trueFrameNum</span> <span class="o">=</span> <span class="n">frameNum</span> <span class="k">if</span> <span class="n">simMetaData</span><span class="p">[</span><span class="s1">&#39;includesInitial&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="n">frameNum</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="c1"># check if single or multiple variable output</span>
                    <span class="k">if</span> <span class="n">simMetaData</span><span class="p">[</span><span class="s1">&#39;numComponents&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># add single header to file</span>
                        <span class="n">vtuFile</span><span class="o">.</span><span class="n">addHeader</span><span class="p">(</span>
                            <span class="n">dataKey</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="n">dataKey</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="n">dataKey</span><span class="p">][:,</span> <span class="n">trueFrameNum</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                            <span class="mi">1</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">simMetaData</span><span class="p">[</span><span class="s1">&#39;numComponents&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">dataKey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">simDataKeysNotVector</span><span class="p">):</span>
                        <span class="c1"># add single header to file with 3 components for vector</span>
                        <span class="n">vtuFile</span><span class="o">.</span><span class="n">addHeader</span><span class="p">(</span>
                            <span class="n">dataKey</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="n">dataKey</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="n">dataKey</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">trueFrameNum</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                            <span class="mi">3</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># add multiple headers to file</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">simMetaData</span><span class="p">[</span><span class="s1">&#39;numComponents&#39;</span><span class="p">]):</span>
                            <span class="n">vtuFile</span><span class="o">.</span><span class="n">addHeader</span><span class="p">(</span>
                                <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2"> </span><span class="si">{:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataKey</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="n">dataKey</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="n">dataKey</span><span class="p">][:,</span> <span class="n">i</span><span class="p">,</span> <span class="n">trueFrameNum</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                                <span class="mi">1</span>
                            <span class="p">)</span>

            <span class="c1"># write element stats headers if required and on first frame</span>
            <span class="k">if</span> <span class="n">includeElStats</span> <span class="ow">and</span> <span class="p">(</span><span class="n">frameNum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elStats</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">vtuFile</span><span class="o">.</span><span class="n">addHeader</span><span class="p">(</span><span class="s2">&quot;Element stat - </span><span class="si">{:}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meshElStatNames</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">elStats</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">elStats</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                                      <span class="mi">1</span><span class="p">)</span>

            <span class="n">vtuFile</span><span class="o">.</span><span class="n">closeElement</span><span class="p">(</span><span class="s2">&quot;CellData&quot;</span><span class="p">)</span>

            <span class="n">vtuFile</span><span class="o">.</span><span class="n">closePiece</span><span class="p">()</span>
            <span class="n">vtuFile</span><span class="o">.</span><span class="n">closeGrid</span><span class="p">()</span>

            <span class="c1"># add actual data to file</span>
            <span class="c1"># mesh defiition stuff</span>
            <span class="n">vtuFile</span><span class="o">.</span><span class="n">appendData</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span>
            <span class="n">vtuFile</span><span class="o">.</span><span class="n">appendData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elmtCon</span><span class="p">[:,</span> <span class="n">CON_ORDER</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span><span class="o">.</span><span class="n">appendData</span><span class="p">(</span><span class="n">offsets</span><span class="p">)</span><span class="o">.</span><span class="n">appendData</span><span class="p">(</span><span class="n">cell_types</span><span class="p">)</span>

            <span class="c1"># simulation data</span>
            <span class="c1"># loop over outputs adding data</span>
            <span class="k">for</span> <span class="n">simMetaData</span> <span class="ow">in</span> <span class="n">simMetaDatas</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">simMetaData</span><span class="p">[</span><span class="s1">&#39;includesInitial&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="p">(</span><span class="n">frameNum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">dataKey</span> <span class="o">=</span> <span class="n">simMetaData</span><span class="p">[</span><span class="s1">&#39;dataKey&#39;</span><span class="p">]</span>
                    <span class="n">trueFrameNum</span> <span class="o">=</span> <span class="n">frameNum</span> <span class="k">if</span> <span class="n">simMetaData</span><span class="p">[</span><span class="s1">&#39;includesInitial&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="n">frameNum</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="c1"># check if single or multiple variable output</span>
                    <span class="k">if</span> <span class="n">simMetaData</span><span class="p">[</span><span class="s1">&#39;numComponents&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># add single data set</span>
                        <span class="n">vtuFile</span><span class="o">.</span><span class="n">appendData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="n">dataKey</span><span class="p">][:,</span> <span class="n">trueFrameNum</span><span class="p">])</span>

                    <span class="k">elif</span> <span class="p">(</span><span class="n">simMetaData</span><span class="p">[</span><span class="s1">&#39;numComponents&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">dataKey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">simDataKeysNotVector</span><span class="p">):</span>
                        <span class="c1"># add vector data set</span>
                        <span class="n">vtuFile</span><span class="o">.</span><span class="n">appendData</span><span class="p">((</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="n">dataKey</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">trueFrameNum</span><span class="p">],</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="n">dataKey</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">trueFrameNum</span><span class="p">],</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="n">dataKey</span><span class="p">][:,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">trueFrameNum</span><span class="p">]</span>
                        <span class="p">))</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># add multiple data sets</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">simMetaData</span><span class="p">[</span><span class="s1">&#39;numComponents&#39;</span><span class="p">]):</span>
                            <span class="n">vtuFile</span><span class="o">.</span><span class="n">appendData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="n">dataKey</span><span class="p">][:,</span> <span class="n">i</span><span class="p">,</span> <span class="n">trueFrameNum</span><span class="p">])</span>

            <span class="c1"># write element stats data if required and on first frame</span>
            <span class="k">if</span> <span class="n">includeElStats</span> <span class="ow">and</span> <span class="p">(</span><span class="n">frameNum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elStats</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">vtuFile</span><span class="o">.</span><span class="n">appendData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elStats</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>

            <span class="n">vtuFile</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">vtgFile</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></div>

<div class="viewcode-block" id="Mesh.combineFiles"><a class="viewcode-back" href="../../defdap.html#defdap.fepx.Mesh.combineFiles">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">combineFiles</span><span class="p">(</span><span class="n">baseDir</span><span class="p">,</span> <span class="n">inDirs</span><span class="p">,</span> <span class="n">outDir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Combine output files from multiple simulations. If a simulation was run in smaller parts</span>

<span class="sd">        Args:</span>
<span class="sd">            baseDir (string): Base directory of whole simulation. No trailing slash</span>
<span class="sd">            inDirs (List(string)): List of simulation directory names to</span>
<span class="sd">                                   combine (baseDir/inDir). No trailing slash</span>
<span class="sd">            outDir (string): Directory to output combined files to (baseDir/outDir)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># no trailing slashes on directory names and inDirs is a list</span>
        <span class="n">fileNames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fileName</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">/</span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">baseDir</span><span class="p">,</span> <span class="n">inDirs</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="s2">&quot;post.*&quot;</span><span class="p">)</span> <span class="ow">and</span>
                <span class="n">fileName</span> <span class="o">!=</span> <span class="s2">&quot;post.conv&quot;</span> <span class="ow">and</span> <span class="n">fileName</span> <span class="o">!=</span> <span class="s2">&quot;post.stats&quot;</span> <span class="ow">and</span> <span class="ow">not</span>
                    <span class="p">(</span><span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="s2">&quot;post.debug.*&quot;</span><span class="p">)</span> <span class="ow">or</span>
                     <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="s2">&quot;post.log.*&quot;</span><span class="p">)</span> <span class="ow">or</span>
                     <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="s2">&quot;post.restart.*&quot;</span><span class="p">)</span>
                     <span class="p">)):</span>

                <span class="n">fileNames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">/</span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">baseDir</span><span class="p">,</span> <span class="n">outDir</span><span class="p">)):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">/</span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">baseDir</span><span class="p">,</span> <span class="n">outDir</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">fileName</span> <span class="ow">in</span> <span class="n">fileNames</span><span class="p">:</span>
            <span class="n">outFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">/</span><span class="si">{:s}</span><span class="s2">/</span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">baseDir</span><span class="p">,</span> <span class="n">outDir</span><span class="p">,</span> <span class="n">fileName</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">inDir</span> <span class="ow">in</span> <span class="n">inDirs</span><span class="p">:</span>
                <span class="n">inFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">/</span><span class="si">{:s}</span><span class="s2">/</span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">baseDir</span><span class="p">,</span> <span class="n">inDir</span><span class="p">,</span> <span class="n">fileName</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">inFile</span><span class="p">:</span>
                    <span class="n">outFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">inFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="n">outFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="Surface"><a class="viewcode-back" href="../../defdap.html#defdap.fepx.Surface">[docs]</a><span class="k">class</span> <span class="nc">Surface</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">surfNum</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">numElmts</span><span class="p">,</span> <span class="n">elmtIDs</span><span class="p">,</span> <span class="n">elmtCon</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surfNum</span> <span class="o">=</span> <span class="n">surfNum</span>          <span class="c1"># Number of surface in mesh (0 based)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">mesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numElmts</span> <span class="o">=</span> <span class="n">numElmts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elmtIDs</span> <span class="o">=</span> <span class="n">elmtIDs</span>          <span class="c1"># Mesh global element IDs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elmtCon</span> <span class="o">=</span> <span class="n">elmtCon</span>          <span class="c1"># Mesh global node IDs</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nodeIDs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elmtCon</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>    <span class="c1"># Mesh global node IDs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numNodes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodeIDs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">forceCalc</span> <span class="o">=</span> <span class="kc">False</span>              <span class="c1"># Set to true to force recalcualtion of all below</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_elmtEdges</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_elmtNeighbours</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_elmtNeighbourEdges</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_grainEdges</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meshEdges</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_neighbourNetwork</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_elmtIDsLayer</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">elmtGrain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns an array of grain IDs for elements in the surface (note grain IDs are 1 based)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">elmtGrain</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">elmtIDs</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">grainIDs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns an array of grain IDs included in the surface</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elmtGrain</span><span class="p">)</span>

    <span class="c1"># properties postfixed with &#39;Layer&#39; are equivalent to those without but take</span>
    <span class="c1"># the first 3d layer of elements not just those with a face in the surface</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">elmtIDsLayer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_elmtIDsLayer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">forceCalc</span><span class="p">:</span>
            <span class="c1"># just corner nodes</span>
            <span class="n">surfaceNodeIDs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elmtCon</span><span class="p">[:,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>

            <span class="c1"># All elements that have a node in the surface</span>
            <span class="n">surfaceElmtIDs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># Find elements with a corner node in the surface</span>
            <span class="k">for</span> <span class="n">elmtID</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">numElmts</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">nodeID</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">elmtCon</span><span class="p">[</span><span class="n">elmtID</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">9</span><span class="p">)]:</span>
                    <span class="k">if</span> <span class="n">nodeID</span> <span class="ow">in</span> <span class="n">surfaceNodeIDs</span><span class="p">:</span>
                        <span class="n">surfaceElmtIDs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elmtID</span><span class="p">)</span>
                        <span class="k">break</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_elmtIDsLayer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">surfaceElmtIDs</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elmtIDsLayer</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">elmtGrainLayer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns an array of grain IDs for elements in the surface (note grain IDs are 1 based)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">elmtGrain</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">elmtIDsLayer</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">grainIDsLayer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns an array of grain IDs included in the surface</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elmtGrainLayer</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">surfaceNormal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">surfNum</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># z surface</span>
            <span class="k">return</span> <span class="s1">&#39;z&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">surfNum</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="c1"># x surface</span>
            <span class="k">return</span> <span class="s1">&#39;x&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">surfNum</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
            <span class="c1"># y surface</span>
            <span class="k">return</span> <span class="s1">&#39;y&#39;</span>

        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Invalid surface.&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">elmtEdges</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Create array with 3 edges of each element</span>
        <span class="c1"># Egdes are ordered tuples of 2 nodeIDs i.e (i, j) where j&gt;i. nodeIDs are global for the mesh</span>
        <span class="c1"># Only use corner nodes (0,2,4), no mid edge nodes</span>
        <span class="c1"># Calculate only if not done before</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_elmtEdges</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">forceCalc</span><span class="p">:</span>
            <span class="n">elmtEdges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">numElmts</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">tuple</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">elmtCon</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elmtCon</span><span class="p">):</span>
                <span class="n">elmtEdges</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">elmtCon</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">elmtCon</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">if</span> <span class="n">elmtCon</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">elmtCon</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="p">(</span><span class="n">elmtCon</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">elmtCon</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">elmtEdges</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">elmtCon</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">elmtCon</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="k">if</span> <span class="n">elmtCon</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">elmtCon</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">else</span> <span class="p">(</span><span class="n">elmtCon</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">elmtCon</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">elmtEdges</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">elmtCon</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">elmtCon</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">elmtCon</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">elmtCon</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">else</span> <span class="p">(</span><span class="n">elmtCon</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">elmtCon</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_elmtEdges</span> <span class="o">=</span> <span class="n">elmtEdges</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elmtEdges</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">elmtNeighbours</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Create element neighbour list. Stored as tuples of 2 local surface elementIDs</span>
        <span class="c1"># Neighbour edges are the edges that are adjacent. global nodeIDs</span>
        <span class="c1"># Might be faster to find elements with a shared node first but this isn&#39;t too slow</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_elmtNeighbours</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_elmtNeighbourEdges</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">forceCalc</span><span class="p">:</span>
            <span class="n">neighbours</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">neighbourEdges</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">elmtEdges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elmtEdges</span>

            <span class="c1"># create list of edges from each element to compare</span>
            <span class="n">neighbourPerms</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                    <span class="n">neighbourPerms</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>

            <span class="c1"># Loop over elements to compare each with all others</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numElmts</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numElmts</span><span class="p">):</span>
                    <span class="c1"># check if any of the edges are the same</span>
                    <span class="k">for</span> <span class="n">perm</span> <span class="ow">in</span> <span class="n">neighbourPerms</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">elmtEdges</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">perm</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">==</span> <span class="n">elmtEdges</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">perm</span><span class="p">[</span><span class="mi">1</span><span class="p">]]:</span>
                            <span class="n">neighbours</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>
                            <span class="n">neighbourEdges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elmtEdges</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">perm</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                            <span class="k">break</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_elmtNeighbours</span> <span class="o">=</span> <span class="n">neighbours</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_elmtNeighbourEdges</span> <span class="o">=</span> <span class="n">neighbourEdges</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elmtNeighbours</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elmtNeighbourEdges</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">grainEdges</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Find grain egdes. Loop over neighbours and if grainID is different add the edges to the list</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_grainEdges</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">forceCalc</span><span class="p">:</span>
            <span class="n">grainEdges</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">neighbours</span><span class="p">,</span> <span class="n">neighbourEdges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elmtNeighbours</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">neighbour</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">neighbours</span><span class="p">):</span>
                <span class="n">grainIDs</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">elmtGrain</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">elmtIDs</span><span class="p">[</span><span class="n">neighbour</span><span class="p">[</span><span class="mi">0</span><span class="p">]]],</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">elmtGrain</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">elmtIDs</span><span class="p">[</span><span class="n">neighbour</span><span class="p">[</span><span class="mi">1</span><span class="p">]]])</span>

                <span class="k">if</span> <span class="n">grainIDs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">grainIDs</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">grainEdges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">neighbourEdges</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_grainEdges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">grainEdges</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grainEdges</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">meshEdges</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_meshEdges</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">forceCalc</span><span class="p">:</span>
            <span class="n">meshEdges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">numElmts</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">edges</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elmtEdges</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">edge</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">edges</span><span class="p">):</span>
                    <span class="n">meshEdges</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_meshEdges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">meshEdges</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meshEdges</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">neighbourNetwork</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_neighbourNetwork</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">forceCalc</span><span class="p">:</span>
            <span class="n">neighboursList</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">neighbours</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elmtNeighbours</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">neighbour</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">neighbours</span><span class="p">):</span>
                <span class="n">grainIDs</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">elmtGrain</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">elmtIDs</span><span class="p">[</span><span class="n">neighbour</span><span class="p">[</span><span class="mi">0</span><span class="p">]]],</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">elmtGrain</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">elmtIDs</span><span class="p">[</span><span class="n">neighbour</span><span class="p">[</span><span class="mi">1</span><span class="p">]]])</span>

                <span class="k">if</span> <span class="n">grainIDs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">grainIDs</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">grainIDs</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">neighboursList</span><span class="p">:</span>
                        <span class="n">neighboursList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grainIDs</span><span class="p">)</span>

            <span class="c1"># create network</span>
            <span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_neighbourNetwork</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_neighbourNetwork</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grainIDs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_neighbourNetwork</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">(</span><span class="n">neighboursList</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_neighbourNetwork</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_2dAxes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">surfaceNormal</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">surfaceNormal</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">surfaceNormal</span> <span class="o">==</span> <span class="s1">&#39;z&#39;</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Surface normal must be x, y or z.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">axes</span>

<div class="viewcode-block" id="Surface.plotStressStrain"><a class="viewcode-back" href="../../defdap.html#defdap.fepx.Surface.plotStressStrain">[docs]</a>    <span class="k">def</span> <span class="nf">plotStressStrain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meshDims</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span> <span class="n">velocity</span><span class="o">=-</span><span class="mf">1e-2</span><span class="p">,</span> <span class="n">revIncs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># revIncs = (180,)</span>
        <span class="c1"># meshDims = (1, 1, 0.2)</span>
        <span class="c1"># velocity = -1e-2</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">surfaceNormal</span> <span class="o">==</span> <span class="s1">&#39;z&#39;</span><span class="p">:</span>
            <span class="c1"># z surface</span>
            <span class="n">areaInitial</span> <span class="o">=</span> <span class="n">meshDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">meshDims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">lengthInitial</span> <span class="o">=</span> <span class="n">meshDims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">forceComp</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">surfaceNormal</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
            <span class="c1"># x surface</span>
            <span class="n">areaInitial</span> <span class="o">=</span> <span class="n">meshDims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">meshDims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">lengthInitial</span> <span class="o">=</span> <span class="n">meshDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">forceComp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">surfaceNormal</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
            <span class="c1"># y surface</span>
            <span class="n">areaInitial</span> <span class="o">=</span> <span class="n">meshDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">meshDims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">lengthInitial</span> <span class="o">=</span> <span class="n">meshDims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">forceComp</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># For surfaces x0, y0, z0 need use negetive force due to coord pointing into sim volume</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">surfNum</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">fileName</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">post.force</span><span class="si">{:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">dataDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">surfNum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">mechData</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="s1">&#39;%&#39;</span><span class="p">)</span>

        <span class="n">force</span> <span class="o">=</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">mechData</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">5</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># force in x, y, z directon</span>
        <span class="n">area</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">mechData</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">areaInitial</span><span class="p">)</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">mechData</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">length</span> <span class="o">=</span> <span class="n">lengthInitial</span> <span class="o">+</span> <span class="n">velocity</span> <span class="o">*</span> <span class="n">time</span>
        <span class="k">if</span> <span class="n">revIncs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">revFactor</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">for</span> <span class="n">revInc</span> <span class="ow">in</span> <span class="n">revIncs</span><span class="p">:</span>
                <span class="n">length</span><span class="p">[</span><span class="n">revInc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">length</span><span class="p">[</span><span class="n">revInc</span><span class="p">]</span> <span class="o">+</span> <span class="n">revFactor</span> <span class="o">*</span> <span class="n">velocity</span> <span class="o">*</span> <span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="n">revInc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">time</span><span class="p">[</span><span class="n">revInc</span><span class="p">])</span>
                <span class="n">revFactor</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="n">strainEng</span> <span class="o">=</span> <span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="n">lengthInitial</span><span class="p">)</span> <span class="o">/</span> <span class="n">lengthInitial</span>
        <span class="n">strainTrue</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">strainEng</span><span class="p">)</span>

        <span class="n">stressEng</span> <span class="o">=</span> <span class="n">force</span><span class="p">[:,</span> <span class="n">forceComp</span><span class="p">]</span> <span class="o">/</span> <span class="n">areaInitial</span>
        <span class="n">stressTrue</span> <span class="o">=</span> <span class="n">force</span><span class="p">[:,</span> <span class="n">forceComp</span><span class="p">]</span> <span class="o">/</span> <span class="n">area</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">strainTrue</span><span class="p">,</span> <span class="n">stressTrue</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;True Strain&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;True Stress (MPa)&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">strainTrue</span><span class="p">,</span> <span class="n">stressTrue</span></div>

<div class="viewcode-block" id="Surface.plotGBs"><a class="viewcode-back" href="../../defdap.html#defdap.fepx.Surface.plotGBs">[docs]</a>    <span class="k">def</span> <span class="nf">plotGBs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colour</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">lc</span> <span class="o">=</span> <span class="n">LineCollection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">nodePos</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_2dAxes</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">grainEdges</span><span class="p">],</span>
                            <span class="n">colors</span><span class="o">=</span><span class="n">colour</span><span class="p">,</span>
                            <span class="n">linewidths</span><span class="o">=</span><span class="n">linewidth</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">add_collection</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span></div>

<div class="viewcode-block" id="Surface.plotMesh"><a class="viewcode-back" href="../../defdap.html#defdap.fepx.Surface.plotMesh">[docs]</a>    <span class="k">def</span> <span class="nf">plotMesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colour</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">lc</span> <span class="o">=</span> <span class="n">LineCollection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">nodePos</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_2dAxes</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">meshEdges</span><span class="p">],</span>
                            <span class="n">colors</span><span class="o">=</span><span class="n">colour</span><span class="p">,</span>
                            <span class="n">linewidths</span><span class="o">=</span><span class="n">linewidth</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">add_collection</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span></div>

<div class="viewcode-block" id="Surface.plotGrainIDs"><a class="viewcode-back" href="../../defdap.html#defdap.fepx.Surface.plotGrainIDs">[docs]</a>    <span class="k">def</span> <span class="nf">plotGrainIDs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">grainID</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grainIDs</span><span class="p">:</span>
            <span class="n">grainElmtIDsLocal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elmtGrain</span> <span class="o">==</span> <span class="n">grainID</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># only corner nodes</span>
            <span class="n">grainNodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elmtCon</span><span class="p">[</span><span class="n">grainElmtIDsLocal</span><span class="p">,</span> <span class="p">:][:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]]</span>
            <span class="n">grainNodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">grainNodes</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>

            <span class="n">grainNodesPos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">nodePos</span><span class="p">[</span><span class="n">grainNodes</span><span class="p">,</span> <span class="p">:]</span>

            <span class="c1"># centre of a bounding box</span>
            <span class="c1"># grainNodesPosMin = grainNodesPos.min(axis=0)</span>
            <span class="c1"># grainNodesPosMax = grainNodesPos.max(axis=0)</span>
            <span class="c1"># grainCentrePos = (grainNodesPosMax + grainNodesPosMin) / 2</span>

            <span class="c1"># mean node position</span>
            <span class="n">grainCentrePos</span> <span class="o">=</span> <span class="n">grainNodesPos</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">grainCentrePos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">grainCentrePos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">grainID</span><span class="p">),</span>
                    <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Surface.plotSimData"><a class="viewcode-back" href="../../defdap.html#defdap.fepx.Surface.plotSimData">[docs]</a>    <span class="k">def</span> <span class="nf">plotSimData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataKey</span><span class="p">,</span> <span class="n">plotType</span><span class="o">=</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">frameNum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">plotGBs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plotMesh</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
                    <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">invertData</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">returnFig</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inputFig</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># validate input data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">_validateSimDataKey</span><span class="p">(</span><span class="n">dataKey</span><span class="p">)</span>
        <span class="n">simMetaData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">simMetaData</span><span class="p">(</span><span class="n">dataKey</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">simMetaData</span><span class="p">[</span><span class="s1">&#39;includesInitial&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">frameNum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">frameNum</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2"> does not have initial data.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataKey</span><span class="p">))</span>

        <span class="c1"># collect unstructured coordinates</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_2dAxes</span>
        <span class="n">cX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">nodePos</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nodeIDs</span><span class="p">,</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">cY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">nodePos</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nodeIDs</span><span class="p">,</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

        <span class="c1"># set area</span>
        <span class="n">extent</span> <span class="o">=</span> <span class="p">(</span><span class="n">cX</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">cX</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">cY</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">cY</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

        <span class="c1"># if input fig is provided then update it else create a new one</span>
        <span class="k">if</span> <span class="n">inputFig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
            <span class="n">newAx</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">img</span> <span class="o">=</span> <span class="n">inputFig</span>
            <span class="n">newAx</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">simMetaData</span><span class="p">[</span><span class="s1">&#39;elmtData&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">simMetaData</span><span class="p">[</span><span class="s1">&#39;grainData&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">simMetaData</span><span class="p">[</span><span class="s1">&#39;elmtData&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">simMetaData</span><span class="p">[</span><span class="s1">&#39;numComponents&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">cData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="n">dataKey</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">elmtIDs</span><span class="p">,</span> <span class="n">frameNum</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="n">dataKey</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">elmtIDs</span><span class="p">,</span> <span class="n">component</span><span class="p">,</span> <span class="n">frameNum</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">simMetaData</span><span class="p">[</span><span class="s1">&#39;numComponents&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">cData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="n">dataKey</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">elmtGrain</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">frameNum</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="n">dataKey</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">elmtGrain</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">component</span><span class="p">,</span> <span class="n">frameNum</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">invertData</span><span class="p">:</span>
                <span class="n">cData</span> <span class="o">=</span> <span class="o">-</span><span class="n">cData</span>

            <span class="n">pc</span> <span class="o">=</span> <span class="n">PolyCollection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">nodePos</span><span class="p">[:,</span> <span class="n">axes</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">elmtCon</span><span class="p">[:,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)]],</span>
                                <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">antialiaseds</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">pc</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
            <span class="n">pc</span><span class="o">.</span><span class="n">set_array</span><span class="p">(</span><span class="n">cData</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">add_collection</span><span class="p">(</span><span class="n">pc</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">simMetaData</span><span class="p">[</span><span class="s1">&#39;nodeData&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">simMetaData</span><span class="p">[</span><span class="s1">&#39;numComponents&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">cData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="n">dataKey</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">nodeIDs</span><span class="p">,</span> <span class="n">frameNum</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">simData</span><span class="p">[</span><span class="n">dataKey</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">nodeIDs</span><span class="p">,</span> <span class="n">component</span><span class="p">,</span> <span class="n">frameNum</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">invertData</span><span class="p">:</span>
                <span class="n">cData</span> <span class="o">=</span> <span class="o">-</span><span class="n">cData</span>

            <span class="c1"># calculate number of points in each direction based on shape of surface</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">extent</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">extent</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">numNodes</span> <span class="o">/</span> <span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">numPoints</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span> <span class="o">*</span> <span class="n">shape</span>
            <span class="n">numPoints</span> <span class="o">=</span> <span class="n">numPoints</span><span class="o">.</span><span class="n">round</span><span class="p">()</span>

            <span class="c1"># create grid and interpolate data to it</span>
            <span class="n">gX</span><span class="p">,</span> <span class="n">gY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="n">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="n">numPoints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span><span class="p">,</span> <span class="n">extent</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">extent</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span><span class="n">numPoints</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span><span class="p">]</span>
            <span class="n">gData</span> <span class="o">=</span> <span class="n">griddata</span><span class="p">(</span><span class="n">cX</span><span class="p">,</span> <span class="n">cY</span><span class="p">,</span> <span class="n">cData</span><span class="p">,</span> <span class="n">gX</span><span class="p">,</span> <span class="n">gY</span><span class="p">,</span> <span class="n">interp</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">inputFig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">plotType</span> <span class="o">==</span> <span class="s2">&quot;contour&quot;</span><span class="p">:</span>
                    <span class="n">contours</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
                    <span class="n">img</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">gX</span><span class="p">,</span> <span class="n">gY</span><span class="p">,</span> <span class="n">gData</span><span class="p">,</span> <span class="n">contours</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
                    <span class="c1"># img = None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">img</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">gData</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
                                    <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>

                <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">plotType</span> <span class="o">==</span> <span class="s2">&quot;contour&quot;</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
                    <span class="n">contours</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
                    <span class="n">img</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">gX</span><span class="p">,</span> <span class="n">gY</span><span class="p">,</span> <span class="n">gData</span><span class="p">,</span> <span class="n">contours</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
                    <span class="c1"># img = None</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
                    <span class="n">newAx</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">img</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">gData</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">plotGBs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plotGBs</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">colour</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plotMesh</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plotMesh</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">colour</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">newAx</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="n">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="n">extent</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">extent</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">returnFig</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">img</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="Surface.animateSimData"><a class="viewcode-back" href="../../defdap.html#defdap.fepx.Surface.animateSimData">[docs]</a>    <span class="k">def</span> <span class="nf">animateSimData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataKey</span><span class="p">,</span> <span class="n">plotType</span><span class="o">=</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                       <span class="n">plotGBs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plotMesh</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
                       <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">invertData</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">saveVid</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="n">simMetaData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">simMetaData</span><span class="p">(</span><span class="n">dataKey</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">simMetaData</span><span class="p">[</span><span class="s1">&#39;includesInitial&#39;</span><span class="p">]:</span>
            <span class="n">frames</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">simMetaData</span><span class="p">[</span><span class="s1">&#39;numFrames&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">frames</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">simMetaData</span><span class="p">[</span><span class="s1">&#39;numFrames&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotSimData</span><span class="p">(</span><span class="n">dataKey</span><span class="p">,</span> <span class="n">plotType</span><span class="o">=</span><span class="n">plotType</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="n">component</span><span class="p">,</span>
                                        <span class="n">frameNum</span><span class="o">=</span><span class="n">frames</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">plotGBs</span><span class="o">=</span><span class="n">plotGBs</span><span class="p">,</span> <span class="n">plotMesh</span><span class="o">=</span><span class="n">plotMesh</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
                                        <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">invertData</span><span class="o">=</span><span class="n">invertData</span><span class="p">,</span> <span class="n">returnFig</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">animate</span><span class="p">(</span><span class="n">frameNum</span><span class="p">):</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">rtnImg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotSimData</span><span class="p">(</span><span class="n">dataKey</span><span class="p">,</span> <span class="n">plotType</span><span class="o">=</span><span class="n">plotType</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="n">component</span><span class="p">,</span>
                                            <span class="n">frameNum</span><span class="o">=</span><span class="n">frameNum</span><span class="p">,</span> <span class="n">plotGBs</span><span class="o">=</span><span class="n">plotGBs</span><span class="p">,</span> <span class="n">plotMesh</span><span class="o">=</span><span class="n">plotMesh</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                            <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">invertData</span><span class="o">=</span><span class="n">invertData</span><span class="p">,</span> <span class="n">returnFig</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                            <span class="n">inputFig</span><span class="o">=</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">img</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">rtnImg</span><span class="p">,</span>

        <span class="c1"># The FuncAnimation must not go out of scope so assigned to an instance variable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anim</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">animate</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="n">frames</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">blit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">saveVid</span><span class="p">:</span>
            <span class="n">fileNameFull</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}{:s}</span><span class="s2">-comp</span><span class="si">{:d}</span><span class="s2">.gif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">dataDir</span><span class="p">,</span> <span class="n">dataKey</span><span class="p">,</span> <span class="n">component</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">fileNameFull</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">anim</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fileNameFull</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">writer</span><span class="o">=</span><span class="s1">&#39;imagemagick&#39;</span><span class="p">)</span></div></div>

            <span class="c1"># self.anim.save(fileNameFull, fps=1, writer=&quot;ffmpeg&quot;, bitrate=-1,</span>
            <span class="c1">#                codec=&quot;libx264&quot;, extra_args=[&#39;-pix_fmt&#39;, &#39;yuv420p&#39;])</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">DefDAP 0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, Michael Atkinson.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.4.
    </div>
  </body>
</html>